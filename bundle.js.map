{
  "version": 3,
  "sources": ["ieeevisdb.ts", "youtubeplayer.ts", "videoplayer.ts", "main.ts"],
  "sourcesContent": ["import {Track} from \"./track\";\r\n\r\ndeclare var firebase;\r\n\r\nexport class IeeeVisDb {\r\n    private trackRef: FirebaseRef;\r\n\r\n    constructor(private onData: (track: Track) => void) {\r\n        this.initFirebase();\r\n    }\r\n\r\n    initFirebase() {\r\n        const firebaseConfig = {\r\n            apiKey: \"AIzaSyCfFQ-eN52od55QBFZatFImgZgEDHK_P4E\",\r\n            authDomain: \"ieeevis.firebaseapp.com\",\r\n            databaseURL: \"https://ieeevis-default-rtdb.firebaseio.com\",\r\n            projectId: \"ieeevis\",\r\n            storageBucket: \"ieeevis.appspot.com\",\r\n            messagingSenderId: \"542997735159\",\r\n            appId: \"1:542997735159:web:6d9624111ec276a61fd5f2\",\r\n            measurementId: \"G-SNC8VC6RFM\"\r\n        };\r\n        // Initialize Firebase\r\n        firebase.initializeApp(firebaseConfig);\r\n        firebase.analytics();\r\n    }\r\n\r\n    loadData() {\r\n        this.trackRef = firebase.database().ref('tracks/track1') as FirebaseRef;\r\n\r\n        this.trackRef.on('value', (snapshot) => {\r\n            this.onData(snapshot.val() as Track);\r\n        });\r\n    }\r\n\r\n    set(path: string, value: string|number|{}) {\r\n        this.trackRef.child(path).set(value);\r\n    }\r\n}\r\n\r\ninterface FirebaseRef {\r\n    child: (childName: string) => FirebaseRef;\r\n    set: (value: string|number|{}) => void;\r\n    on: (event: \"value\", cb: (data: any) => void) => void;\r\n}", "export interface YoutubePlayer {\r\n    playVideo: () => void;\r\n    //playVideoAt: (time: number) => void;\r\n    pauseVideo: () => void;\r\n    loadVideoById: (videoId: string, startTime?: number, size?: string) => void;\r\n    mute: () => void;\r\n    unMute: () => void;\r\n    seekTo: (timeS: number, allowSeekAhead: boolean) => void;\r\n    getDuration: () => number;\r\n    getCurrentTime: () => number;\r\n}\r\n\r\nexport enum PlayerState {\r\n    UNSTARTED = -1,\r\n    ENDED = 0,\r\n    PLAYING = 1,\r\n    PAUSED = 2,\r\n    BUFFERING = 3,\r\n    CUED = 5\r\n}", "import {PlayerState, YoutubePlayer} from \"./youtubeplayer\";\r\nimport {Video, VideoStatus} from \"./track\";\r\n\r\ndeclare var YT;\r\n\r\nexport class IeeeVisVideoPlayer {\r\n    player: YoutubePlayer;\r\n    audioContext = new AudioContext();\r\n\r\n    youtubeApiReady = false;\r\n    youtubePlayerLoaded = false;\r\n    youtubePlayerReady = false;\r\n\r\n    constructor(private elementId: string,\r\n                private width: number,\r\n                private height: number,\r\n                private getCurrentVideo: () => Video,\r\n                private getCurrentVideoId: () => string,\r\n                private getCurrentVideoStatus: () => VideoStatus) {\r\n        this.init();\r\n    }\r\n\r\n    onYouTubeIframeAPIReady() {\r\n        this.youtubeApiReady = true;\r\n    }\r\n\r\n    init() {\r\n        const tag = document.createElement('script');\r\n        tag.src = \"https://www.youtube.com/iframe_api\";\r\n        const firstScriptTag = document.getElementsByTagName('script')[0];\r\n        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);\r\n    }\r\n\r\n    onPlayerReady() {\r\n        console.log('player ready', this.player);\r\n        this.youtubePlayerReady = true;\r\n\r\n        if(this.audioContext.state === \"suspended\") {\r\n            this.player.mute();\r\n        }\r\n        this.player.playVideo();\r\n    }\r\n\r\n\r\n    lastForcedSeek = 0;\r\n\r\n    onPlayerStateChange(state: {target: YoutubePlayer, data: PlayerState}) {\r\n        if(state.data === PlayerState.UNSTARTED) {\r\n            // This is to force the player to go to 0 because it does not recognize 0 as a start time in loadVideoById.\r\n            this.player.seekTo(this.getCurrentStartTimeS(), true);\r\n        }\r\n\r\n        if(state.data === PlayerState.PLAYING || state.data === PlayerState.BUFFERING) {\r\n            const startTime = this.getCurrentStartTimeS();\r\n            const currentTime = this.player.getCurrentTime();\r\n            if(Math.abs(startTime - currentTime) > 5 && Date.now() - this.lastForcedSeek > 10000) {\r\n                this.player.seekTo(this.getCurrentStartTimeS(), true);\r\n                console.log('lagging behind. seek.', this.getCurrentStartTimeS(), this.player.getCurrentTime());\r\n                this.lastForcedSeek = Date.now();\r\n            }\r\n        }\r\n    }\r\n\r\n    loadYoutubePlayer() {\r\n        this.youtubePlayerLoaded = true;\r\n\r\n        this.player = new YT.Player(this.elementId, {\r\n            width: this.width,\r\n            height: this.height,\r\n            videoId: this.getCurrentVideoId(),\r\n\r\n            playerVars: {\r\n                'playsinline': 1,\r\n                'autoplay': 1,\r\n                'controls': 1,\r\n                'rel': 0,\r\n                'modestbranding': 1,\r\n                'mute': 0,\r\n                start: this.getCurrentStartTimeS(),\r\n            },\r\n            events: {\r\n                'onReady': this.onPlayerReady.bind(this),\r\n                'onStateChange': this.onPlayerStateChange.bind(this),\r\n            }\r\n        });\r\n    }\r\n\r\n    updateVideo() {\r\n        if(!this.getCurrentVideoId() || !this.youtubeApiReady) {\r\n            return;\r\n        }\r\n\r\n        if(!this.youtubePlayerLoaded) {\r\n            this.loadYoutubePlayer();\r\n        } else {\r\n            this.changeYoutubeVideo();\r\n        }\r\n    }\r\n\r\n    changeYoutubeVideo() {\r\n        // The seeking in the following line does not work for 0 (see workaround above).\r\n        this.player.loadVideoById(this.getCurrentVideoId(), this.getCurrentStartTimeS());\r\n        this.player.playVideo();\r\n        this.lastForcedSeek = 0;\r\n    }\r\n\r\n    getCurrentStartTimeS() {\r\n        if(this.getCurrentVideo().type === 'prerecorded' || !this.youtubePlayerReady) {\r\n            const timeMs = new Date().getTime();\r\n            const videoStartTimestampMs = this.getCurrentVideoStatus()?.videoStartTimestamp;\r\n\r\n            return Math.round((timeMs - videoStartTimestampMs) / 1000);\r\n        } else if(this.getCurrentVideo().type === 'live') {\r\n            return this.player.getDuration();\r\n        }\r\n    }\r\n}", "import {Track, Video} from \"./track\";\r\nimport {IeeeVisDb} from \"./ieeevisdb\";\r\nimport {IeeeVisVideoPlayer} from \"./videoplayer\";\r\n\r\ntype PANEL_TAB = \"slido\" | \"discord\";\r\n\r\nclass IeeeVisStream {\r\n    static PLAYER_ELEMENT_ID = 'ytplayer';\r\n    static CONTENT_WRAPPER_ID = 'content';\r\n    static GATHERTOWN_WRAPPER_ID = 'gathertown';\r\n    static PANEL_HEADER_ID = 'panel-header';\r\n\r\n    data: Track;\r\n    player: IeeeVisVideoPlayer;\r\n    db: IeeeVisDb;\r\n\r\n    width = window.innerWidth;\r\n    height = window.innerHeight - 120; // 80px for title\r\n\r\n    CHAT_WIDTH_PERCENT = 40;\r\n    CHAT_PADDING_LEFT_PX = 20;\r\n    GATHERTOWN_HEIGHT_PERCENT = 40;\r\n    static HEADERS_HEIGHT = 30;\r\n\r\n    currentPanelTab: PANEL_TAB = \"discord\";\r\n\r\n    constructor() {\r\n        this.db = new IeeeVisDb(this.onData.bind(this));\r\n        this.player = new IeeeVisVideoPlayer(IeeeVisStream.PLAYER_ELEMENT_ID,\r\n            this.width * (100 - this.CHAT_WIDTH_PERCENT) / 100,\r\n            (this.height - IeeeVisStream.HEADERS_HEIGHT * 2) * (100 - this.GATHERTOWN_HEIGHT_PERCENT) / 100,\r\n            this.getCurrentVideo.bind(this),\r\n            this.getCurrentVideoId.bind(this),\r\n            () => this.data?.currentStatus);\r\n        this.db.loadData();\r\n\r\n        this.loadDiscord();\r\n        this.loadSlido();\r\n        this.loadGathertown();\r\n        this.initPanelTabs();\r\n    }\r\n\r\n    onYouTubeIframeAPIReady() {\r\n        this.player.onYouTubeIframeAPIReady();\r\n    }\r\n\r\n    loadDiscord() {\r\n        const html = `<iframe src=\"https://titanembeds.com/embed/851543399982170163?defaultchannel=851543400461107241\"\r\n                              width=\"${this.width * this.CHAT_WIDTH_PERCENT / 100 - this.CHAT_PADDING_LEFT_PX}\"\r\n                              height=\"${this.height - IeeeVisStream.HEADERS_HEIGHT}\"\r\n                              frameborder=\"0\"></iframe>`;\r\n        document.getElementById('discord-wrap').innerHTML += html;\r\n    }\r\n\r\n    loadSlido() {\r\n        const frame = document.getElementById('slido-frame');\r\n        frame.setAttribute('width', `${this.width * this.CHAT_WIDTH_PERCENT / 100 - this.CHAT_PADDING_LEFT_PX}`);\r\n        frame.setAttribute('height', `${this.height - IeeeVisStream.HEADERS_HEIGHT}`);\r\n    }\r\n\r\n    loadGathertown() {\r\n        const html = `<iframe title=\"gather town\"\r\n                              width=\"${this.width * (100 - this.CHAT_WIDTH_PERCENT) / 100}\"\r\n                              height=\"${(this.height - IeeeVisStream.HEADERS_HEIGHT * 2) * (this.GATHERTOWN_HEIGHT_PERCENT) / 100}\"\r\n                              allow=\"camera;microphone\"\r\n                              src=\"https://gather.town/app/aDeS7vVGW5A2wuF5/vis21-tech2\"></iframe>`;\r\n\r\n        const contentWrap = document.getElementById(IeeeVisStream.CONTENT_WRAPPER_ID);\r\n        contentWrap.style.width = `${this.width * (100 - this.CHAT_WIDTH_PERCENT) / 100}px`;\r\n\r\n        const gatherWrap = document.getElementById(IeeeVisStream.GATHERTOWN_WRAPPER_ID);\r\n        gatherWrap.innerHTML = html;\r\n    }\r\n\r\n    onData(track: Track) {\r\n        const lastYtId = this.getCurrentVideoId();\r\n        this.data = track;\r\n\r\n        document.getElementById('track-title').innerText = this.data.name;\r\n\r\n        if(this.getCurrentVideoId() != lastYtId) {\r\n            this.player.updateVideo();\r\n        }\r\n    }\r\n\r\n    getCurrentVideo(): Video {\r\n        return this.data?.videos[this.data?.currentStatus?.videoIndex];\r\n    }\r\n\r\n    getCurrentVideoId() {\r\n        return this.getCurrentVideo()?.youtubeId;\r\n    }\r\n\r\n    initPanelTabs() {\r\n        const getToggle = (tabName: PANEL_TAB) => () => {\r\n            console.log(tabName);\r\n            this.currentPanelTab = tabName;\r\n\r\n            document.getElementById('discord-tab-link').className = '';\r\n            document.getElementById('slido-tab-link').className = '';\r\n            document.getElementById(`${tabName}-tab-link`).className = 'active';\r\n\r\n            document.getElementById('discord-wrap').className = '';\r\n            document.getElementById('slido-wrap').className = '';\r\n            document.getElementById(`${tabName}-wrap`).className = 'active';\r\n        };\r\n\r\n        document.getElementById('discord-tab-link').onclick = getToggle('discord');\r\n        document.getElementById('slido-tab-link').onclick = getToggle('slido');\r\n    }\r\n}\r\n\r\nconst stream = new IeeeVisStream();\r\nexport declare var onYouTubeIframeAPIReady;\r\n\r\nonYouTubeIframeAPIReady = () => {\r\n    stream.onYouTubeIframeAPIReady();\r\n}"],
  "mappings": "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",
  "names": []
}
